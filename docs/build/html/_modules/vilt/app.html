

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>vilt.app &mdash; Virtual Learning Tutor (ViLT) 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Virtual Learning Tutor (ViLT)
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">project</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Virtual Learning Tutor (ViLT)</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">vilt.app</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for vilt.app</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">signal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ast</span><span class="w"> </span><span class="kn">import</span> <span class="n">literal_eval</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cheroot.wsgi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Server</span> <span class="k">as</span> <span class="n">WSGIServer</span><span class="p">,</span> <span class="n">PathInfoDispatcher</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dash</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dash</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dash.dependencies</span><span class="w"> </span><span class="kn">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Output</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">send_file</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.middleware.dispatcher</span><span class="w"> </span><span class="kn">import</span> <span class="n">DispatcherMiddleware</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">secure_filename</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">vilt.careermanager</span><span class="w"> </span><span class="kn">import</span> <span class="n">CareersManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vilt.chatbotmanager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatbotManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vilt.dashmanager</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vilt.docmanager</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocManager</span><span class="p">,</span> <span class="n">process_students_excel</span><span class="p">,</span> <span class="n">create_password</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vilt.infomanager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_career_subject_from_string</span><span class="p">,</span> <span class="n">get_string_from_career_subject</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vilt.timemanager</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vilt.usermanager</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>


<div class="viewcode-block" id="clean_chatbot">
<a class="viewcode-back" href="../../vilt.html#vilt.app.clean_chatbot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_chatbot</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleans up a chatbot instance for a specific user and subject.</span>

<span class="sd">    If a conversation is active, it is ended before removing the chatbot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    email : str</span>
<span class="sd">        The email of the user.</span>
<span class="sd">    selected_career : str</span>
<span class="sd">        The career associated with the chatbot and the user.</span>
<span class="sd">    selected_subject : str</span>
<span class="sd">        The subject associated with the chatbot and the user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">selected_career</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">selected_subject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">chatbot_manager</span><span class="o">.</span><span class="n">find_chatbot</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">chatbot_manager</span><span class="o">.</span><span class="n">chatbots</span><span class="p">[</span><span class="n">email</span><span class="p">][</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
                <span class="k">if</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">has_active_conversation</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">):</span>
                    <span class="n">user_manager</span><span class="o">.</span><span class="n">end_conversation</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                <span class="n">chatbot_manager</span><span class="o">.</span><span class="n">remove_chatbot</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span></div>



<div class="viewcode-block" id="clean_chatbots_by_student">
<a class="viewcode-back" href="../../vilt.html#vilt.app.clean_chatbots_by_student">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_chatbots_by_student</span><span class="p">(</span><span class="n">student</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleans up all chatbot instances associated with a specific student.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    student : dict</span>
<span class="sd">        Dictionary containing student information, including email and enrolled subjects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">student</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">enrolled</span> <span class="ow">in</span> <span class="n">student</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">]:</span>
        <span class="n">selected_career</span> <span class="o">=</span> <span class="n">enrolled</span><span class="p">[</span><span class="s1">&#39;career&#39;</span><span class="p">]</span>
        <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">enrolled</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span>
        <span class="n">clean_chatbot</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span></div>



<div class="viewcode-block" id="clean_all_chatbots">
<a class="viewcode-back" href="../../vilt.html#vilt.app.clean_all_chatbots">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_all_chatbots</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleans up all chatbot instances for all students in the system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
    <span class="n">students</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_role</span><span class="p">(</span><span class="s1">&#39;student&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">student</span> <span class="ow">in</span> <span class="n">students</span><span class="p">:</span>
        <span class="n">clean_chatbots_by_student</span><span class="p">(</span><span class="n">student</span><span class="p">)</span></div>



<div class="viewcode-block" id="kill_handler">
<a class="viewcode-back" href="../../vilt.html#vilt.app.kill_handler">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">kill_handler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles system termination by cleaning up chatbots and stopping processes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *args : Python object</span>
<span class="sd">        Additional arguments passed by the system signal handler.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cleaning up </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">time_manager</span><span class="o">.</span><span class="n">end_all_process</span><span class="p">()</span>
    <span class="n">clean_all_chatbots</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes and configures the Flask and Dash applications.</span>

<span class="sd">    - Creates the main Flask server.</span>
<span class="sd">    - Sets up a Dash dashboard within the Flask app.</span>
<span class="sd">    - Configures application settings, including session management.</span>
<span class="sd">    - Registers signal handlers for proper cleanup on termination.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">project_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">/</span><span class="s1">&#39;..&#39;</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">static_folder</span><span class="o">=</span><span class="n">project_folder</span> <span class="o">/</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="n">template_folder</span><span class="o">=</span><span class="n">project_folder</span> <span class="o">/</span> <span class="s1">&#39;templates&#39;</span><span class="p">)</span>
    <span class="n">dash_app</span> <span class="o">=</span> <span class="n">Dash</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">,</span> <span class="n">url_base_pathname</span><span class="o">=</span><span class="s1">&#39;/dashapp/&#39;</span><span class="p">,</span> <span class="n">assets_folder</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">project_folder</span><span class="o">/</span><span class="s1">&#39;static&#39;</span><span class="p">))</span>
    <span class="n">dash_app</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;ViLT&#39;</span>
    <span class="n">dash_app</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">Div</span><span class="p">()</span>

    <span class="k">with</span> <span class="n">server</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="n">dispatcher</span> <span class="o">=</span> <span class="n">DispatcherMiddleware</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;dashapp&#39;</span><span class="p">:</span> <span class="n">dash_app</span><span class="o">.</span><span class="n">server</span><span class="p">})</span>

    <span class="n">server</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PROCESS_FOLDER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_folder</span><span class="o">/</span><span class="s1">&#39;processed_docs&#39;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SESSION_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;filesystem&#39;</span>
    <span class="n">server</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;super secret key&#39;</span>

    <span class="n">chatbot_manager</span> <span class="o">=</span> <span class="n">ChatbotManager</span><span class="p">()</span>
    <span class="n">time_manager</span> <span class="o">=</span> <span class="n">TimeManager</span><span class="p">()</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">kill_handler</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">kill_handler</span><span class="p">)</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Renders the home page.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered home page template.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;home.html&#39;</span><span class="p">)</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">home</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles the home page POST request.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered home page template.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;home.html&#39;</span><span class="p">)</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/reset-page&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset_page</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets the page and refreshes user session information.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with updated user session information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reset page for user: </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">users</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">template</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">select_initial_template</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">select_initial_template</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines the initial template based on user role.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        user : dict</span>
<span class="sd">            A dictionary containing user information, including role and subjects.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            A tuple containing the selected template (str) and a list of subjects (list of str).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin.html&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">]:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_string_from_career_subject</span><span class="p">(</span><span class="n">subject</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;teacher&#39;</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;teacher.html&#39;</span>
            <span class="k">elif</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;student&#39;</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;student.html&#39;</span>
        <span class="k">return</span> <span class="n">template</span><span class="p">,</span> <span class="n">result</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles user login and session management.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template corresponding to the user role or an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
            <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-pass&#39;</span><span class="p">)</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_user</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
            <span class="k">if</span> <span class="n">users</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">correct</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
                    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;El usuario ya está activo en el sistema.&#39;</span><span class="p">)</span>
                    <span class="n">correct</span> <span class="o">=</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span> <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span>
                        <span class="n">email</span><span class="p">)</span> <span class="k">else</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">add_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">correct</span> <span class="o">=</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">add_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">correct</span><span class="p">:</span>
                    <span class="n">template</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">select_initial_template</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;El usuario o la contraseña son incorrectos.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/teacher-subjects-teachers&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">teacher_subjects_teachers</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles requests related to teacher-subject interactions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with relevant information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">role</span> <span class="o">=</span> <span class="s1">&#39;teacher&#39;</span>
            <span class="n">option</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select-subjects&#39;</span><span class="p">)</span>
            <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">get_career_subject_from_string</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
            <span class="n">career_manager</span> <span class="o">=</span> <span class="n">CareersManager</span><span class="p">()</span>
            <span class="n">subjects</span> <span class="o">=</span> <span class="n">career_manager</span><span class="o">.</span><span class="n">query_subjects</span><span class="p">(</span><span class="n">selected_career</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">selected_subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;teachers&#39;</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">get_teachers_for_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_consult_subject_teachers.html&#39;</span>
                <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;students&#39;</span><span class="p">:</span>
                    <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">get_users_by_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_consult_students.html&#39;</span>
                <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;docs&#39;</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">get_docs_from_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_docs.html&#39;</span>
                <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;stats&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">render_dashboard</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Carrera y asignatura no válidas en el sistema.&#39;</span><span class="p">)</span>
                <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
                <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">]:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_string_from_career_subject</span><span class="p">(</span><span class="n">subject</span><span class="p">))</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;teacher.html&#39;</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-type&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_type</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles requests related to administrative options.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template corresponding to the selected administrative option.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;admins&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">admin</span> <span class="ow">in</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_role</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">admin</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_admins.html&#39;</span>
            <span class="k">elif</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;teachers&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">teacher</span> <span class="ow">in</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_role</span><span class="p">(</span><span class="s1">&#39;teacher&#39;</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">teacher</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_teachers.html&#39;</span>
            <span class="k">elif</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;careers&#39;</span><span class="p">:</span>
                <span class="n">career_manager</span> <span class="o">=</span> <span class="n">CareersManager</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">career</span> <span class="ow">in</span> <span class="n">career_manager</span><span class="o">.</span><span class="n">query_careers</span><span class="p">():</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">career</span><span class="p">[</span><span class="s1">&#39;career&#39;</span><span class="p">])</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_careers.html&#39;</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_emails</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">param_email</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves a list of user emails based on their role.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        role : str</span>
<span class="sd">            The role of the users to query (&#39;admin&#39;, &#39;teacher&#39; or &#39;student&#39;).</span>
<span class="sd">        param_email : str</span>
<span class="sd">            The email of the requesting user.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with the list of user emails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">param_email</span>
        <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
        <span class="n">new_users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_role</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">new_users</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
        <span class="n">result</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_admins.html&#39;</span>
        <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;teacher&#39;</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_teachers.html&#39;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_starting_page_user</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines the starting page template for a user based on their role.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        email : str</span>
<span class="sd">            The email address of the user.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            A tuple containing the selected template (str) and a list of subjects (list of str).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin.html&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">]:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_string_from_career_subject</span><span class="p">(</span><span class="n">subject</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;teacher&#39;</span><span class="p">:</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;teacher.html&#39;</span>
                <span class="k">elif</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;student&#39;</span><span class="p">:</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;student.html&#39;</span>
        <span class="k">return</span> <span class="n">template</span><span class="p">,</span> <span class="n">result</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/go-main-back&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">go_main_back</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redirects the user back to their main page.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template corresponding to the user&#39;s starting page.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">template</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">get_starting_page_user</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-admins&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_admins</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles administrative actions related to admin users.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template corresponding to the selected admin action.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">selected_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select-admins&#39;</span><span class="p">)</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;new&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;admin_add_admins.html&#39;</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;consult&#39;</span><span class="p">:</span>
                <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">selected_email</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;admin_consult_admins.html&#39;</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El administrador no ha sido encontrado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">get_emails</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;modify&#39;</span><span class="p">:</span>
                <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">selected_email</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;admin_modify_admins.html&#39;</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El administrador no ha sido encontrado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">get_emails</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">delete_admin</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">delete_admin</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes an admin user from the system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        email : str</span>
<span class="sd">            The email address of the admin requesting the deletion.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response</span>
<span class="sd">            The rendered template with the updated admin list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">selected_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select-admins&#39;</span><span class="p">)</span>
        <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">selected_email</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">user_manager</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">selected_email</span><span class="p">))</span>
                <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Administrador eliminado correctamente.&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El administrador no ha sido encontrado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">get_emails</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/add-admin&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_admin</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new admin user to the system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with success or error messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-name&#39;</span><span class="p">)</span>
            <span class="n">new_surname</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-surname&#39;</span><span class="p">)</span>
            <span class="n">new_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-email&#39;</span><span class="p">)</span>
            <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-pass&#39;</span><span class="p">)</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">new_email</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El usuario ya está en el sistema.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_add_admins.html&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="n">new_surname</span><span class="p">,</span> <span class="n">new_email</span><span class="p">,</span> <span class="n">new_password</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">)</span>
                    <span class="n">user_manager</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="n">to_json</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">found_user</span> <span class="ow">in</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_role</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">):</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">found_user</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Administrador añadido correctamente.&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_admins.html&#39;</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/consult-admin&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">consult_admin</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves and displays the list of admin users.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with the admin users list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">get_emails</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/modify-admin&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">modify_admin</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modifies an existing admin user’s information.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with success or error messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-name&#39;</span><span class="p">)</span>
            <span class="n">new_surname</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-surname&#39;</span><span class="p">)</span>
            <span class="n">old_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old-email&#39;</span><span class="p">)</span>
            <span class="n">new_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-email&#39;</span><span class="p">)</span>
            <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-pass&#39;</span><span class="p">)</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">old_users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">old_email</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">user_manager</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">old_email</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="n">digest</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">old_users</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_password</span><span class="p">:</span>
                        <span class="n">digest</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="n">new_surname</span><span class="p">,</span> <span class="n">new_email</span><span class="p">,</span> <span class="n">new_password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="n">digest</span><span class="o">=</span><span class="n">digest</span><span class="p">)</span>
                    <span class="n">user_manager</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="n">to_json</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">get_emails</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-teachers&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_teachers</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles administrative actions related to teachers.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template based on the selected action.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">)</span>
            <span class="n">selected_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select-teachers&#39;</span><span class="p">)</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;new&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;admin_add_teachers.html&#39;</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;consult&#39;</span><span class="p">:</span>
                <span class="n">selected_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select-teachers&#39;</span><span class="p">)</span>
                <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">selected_email</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;admin_consult_teachers.html&#39;</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El profesor no ha sido encontrado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">get_emails</span><span class="p">(</span><span class="s1">&#39;teacher&#39;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;modify&#39;</span><span class="p">:</span>
                <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">selected_email</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;admin_modify_teachers.html&#39;</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El profesor no ha sido encontrado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">get_emails</span><span class="p">(</span><span class="s1">&#39;teacher&#39;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">delete_teacher</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">delete_teacher</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes a teacher from the system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with updated teacher list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">selected_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select-teachers&#39;</span><span class="p">)</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">selected_email</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">user_manager</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">selected_email</span><span class="p">))</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Profesor eliminado correctamente.&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El profesor no ha sido encontrado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">get_emails</span><span class="p">(</span><span class="s1">&#39;teacher&#39;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha finalizado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/add-teacher&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_teacher</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new teacher to the system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with success or error messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-name&#39;</span><span class="p">)</span>
            <span class="n">new_surname</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-surname&#39;</span><span class="p">)</span>
            <span class="n">new_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-email&#39;</span><span class="p">)</span>
            <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-pass&#39;</span><span class="p">)</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">new_email</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El usuario ya está en el sistema.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_add_teachers.html&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="n">new_surname</span><span class="p">,</span> <span class="n">new_email</span><span class="p">,</span> <span class="n">new_password</span><span class="p">,</span> <span class="s1">&#39;teacher&#39;</span><span class="p">)</span>
                    <span class="n">user_manager</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="n">to_json</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">found_user</span> <span class="ow">in</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_role</span><span class="p">(</span><span class="s1">&#39;teacher&#39;</span><span class="p">):</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">found_user</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Profesor añadido correctamente.&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_teachers.html&#39;</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/consult-teacher&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">consult_teacher</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves and displays the list of teacher users.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with the teacher users list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">get_emails</span><span class="p">(</span><span class="s1">&#39;teacher&#39;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/modify-teacher&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">modify_teacher</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modifies an existing teacher’s information.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with success or error messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-name&#39;</span><span class="p">)</span>
            <span class="n">new_surname</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-surname&#39;</span><span class="p">)</span>
            <span class="n">old_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;old-email&#39;</span><span class="p">)</span>
            <span class="n">new_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-email&#39;</span><span class="p">)</span>
            <span class="n">new_password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-pass&#39;</span><span class="p">)</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">old_users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">old_email</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">user_manager</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">old_email</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="n">digest</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">old_users</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_password</span><span class="p">:</span>
                        <span class="n">digest</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="n">new_surname</span><span class="p">,</span> <span class="n">new_email</span><span class="p">,</span> <span class="n">new_password</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;teacher&#39;</span><span class="p">,</span> <span class="n">digest</span><span class="o">=</span><span class="n">digest</span><span class="p">)</span>
                    <span class="n">user_manager</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="n">to_json</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">get_emails</span><span class="p">(</span><span class="s1">&#39;teacher&#39;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-careers&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_careers</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Administrates careers and subjects data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response: str</span>
<span class="sd">            The rendered template with career and subject information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select-careers&#39;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">career_manager</span> <span class="o">=</span> <span class="n">CareersManager</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">career</span> <span class="ow">in</span> <span class="n">career_manager</span><span class="o">.</span><span class="n">query_careers</span><span class="p">():</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">career</span><span class="p">[</span><span class="s1">&#39;career&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">selected_career</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">career_manager</span><span class="o">.</span><span class="n">query_subjects</span><span class="p">(</span><span class="n">selected_career</span><span class="p">)</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subjects.html&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La titulación seleccionada no ha sido encontrada.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_careers.html&#39;</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_docs_from_subject</span><span class="p">(</span><span class="n">career</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves all PDF documents associated with a given career and subject.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        career : str</span>
<span class="sd">            The career associated with the subject.</span>
<span class="sd">        subject : str</span>
<span class="sd">            The subject whose documents are being retrieved.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        docs : list</span>
<span class="sd">            A list of document filenames.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PROCESS_FOLDER&#39;</span><span class="p">]),</span> <span class="n">career</span><span class="p">),</span> <span class="n">subject</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pdf&#39;</span><span class="p">):</span>
                    <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">docs</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_teachers_for_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves a list of teachers associated with a specific subject.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        selected_career : str</span>
<span class="sd">            The career associated with the subject.</span>
<span class="sd">        selected_subject : str</span>
<span class="sd">            The subject whose teachers are being retrieved.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : list</span>
<span class="sd">            A list of teacher emails associated with the subject.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
        <span class="n">teachers</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_role</span><span class="p">(</span><span class="s1">&#39;teacher&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">teacher</span> <span class="ow">in</span> <span class="n">teachers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">teacher</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">subject</span><span class="p">[</span><span class="s1">&#39;career&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">selected_career</span> <span class="ow">and</span> <span class="n">subject</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">selected_subject</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">teacher</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">result</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-careers-back&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_careers_back</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns to the careers administration view.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with career information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">career_manager</span> <span class="o">=</span> <span class="n">CareersManager</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">career</span> <span class="ow">in</span> <span class="n">career_manager</span><span class="o">.</span><span class="n">query_careers</span><span class="p">():</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">career</span><span class="p">[</span><span class="s1">&#39;career&#39;</span><span class="p">])</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_careers.html&#39;</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-subjects-back&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_subjects_back</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns to the subjects administration view.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with subject information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span>
                    <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career_hidden&#39;</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">career_manager</span> <span class="o">=</span> <span class="n">CareersManager</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">career</span> <span class="ow">in</span> <span class="n">career_manager</span><span class="o">.</span><span class="n">query_careers</span><span class="p">():</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">career</span><span class="p">[</span><span class="s1">&#39;career&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">selected_career</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">career_manager</span><span class="o">.</span><span class="n">query_subjects</span><span class="p">(</span><span class="n">selected_career</span><span class="p">)</span>
                        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subjects.html&#39;</span>
                <span class="k">elif</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;teacher&#39;</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">]:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_string_from_career_subject</span><span class="p">(</span><span class="n">subject</span><span class="p">))</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;teacher.html&#39;</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-add-man-students&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_add_man_students</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manually adds a student to a selected subject within a career.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with a success or error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject_hidden&#39;</span><span class="p">)</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-name&#39;</span><span class="p">)</span>
            <span class="n">new_surname</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-surname&#39;</span><span class="p">)</span>
            <span class="n">new_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-email&#39;</span><span class="p">)</span>
            <span class="n">new_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;new-id&#39;</span><span class="p">)</span>
            <span class="n">new_password</span> <span class="o">=</span> <span class="n">create_password</span><span class="p">(</span><span class="n">new_id</span><span class="p">,</span> <span class="n">new_email</span><span class="p">)</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">new_email</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="n">new_surname</span><span class="p">,</span> <span class="n">new_email</span><span class="p">,</span> <span class="n">new_password</span><span class="p">,</span> <span class="s1">&#39;student&#39;</span><span class="p">)</span>
                    <span class="n">user_manager</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="n">to_json</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">to_json</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">has_user_subject</span><span class="p">(</span><span class="n">new_email</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">user_manager</span><span class="o">.</span><span class="n">add_subject</span><span class="p">(</span><span class="n">new_email</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Estudiante añadido correctamente a la asignatura.&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">get_docs_from_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_students.html&#39;</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-upload-students&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_upload_students</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uploads a list of students from an Excel file and assigns them to a subject.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with a success or error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;upload-file&#39;</span><span class="p">]</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject_hidden&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No se ha seleccionado un documento nuevo para el temario.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xls&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">):</span>
                <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El documento no es un fichero adecuado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                    <span class="n">process_students_excel</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">get_docs_from_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_students.html&#39;</span>
                <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Los estudiantes han sido añadidos a la asignatura.&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-consult-students&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_consult_students</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves a list of students associated with a selected subject and career.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response</span>
<span class="sd">            The rendered template with student data or an error message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject_hidden&#39;</span><span class="p">)</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;teacher&#39;</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">]:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_string_from_career_subject</span><span class="p">(</span><span class="n">subject</span><span class="p">))</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;teacher.html&#39;</span>
                <span class="k">elif</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">get_docs_from_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_students.html&#39;</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-remove-students&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_remove_students</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes selected students from a subject and deletes them if they are not enrolled in other subjects.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response</span>
<span class="sd">            The rendered template with success or error messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject_hidden&#39;</span><span class="p">)</span>
            <span class="n">marked_email_list</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;marked&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">marked_email_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">marked_email</span> <span class="ow">in</span> <span class="n">marked_email_list</span><span class="p">:</span>
                        <span class="n">user_manager</span><span class="o">.</span><span class="n">remove_subject</span><span class="p">(</span><span class="n">marked_email</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                        <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">marked_email</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">user_manager</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">marked_email</span><span class="p">)</span>
                <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Los estudiantes seleccionados fueron eliminados de la asignatura.&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No se han seleccionado estudiantes.&#39;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">get_docs_from_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_students.html&#39;</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-students&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_students</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles different administrative actions related to students.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with relevant student-related information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject_hidden&#39;</span><span class="p">)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_add_students.html&#39;</span>
            <span class="k">elif</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;add-man&#39;</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_add_students_man.html&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">get_users_by_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;consult&#39;</span><span class="p">:</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_consult_students.html&#39;</span>
                <span class="k">elif</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_remove_students.html&#39;</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-subjects&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_subjects</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles administrative actions related to subjects within a career.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template based on the selected action.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select-subjects&#39;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">career_manager</span> <span class="o">=</span> <span class="n">CareersManager</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">career</span> <span class="ow">in</span> <span class="n">career_manager</span><span class="o">.</span><span class="n">query_careers</span><span class="p">():</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">career</span><span class="p">[</span><span class="s1">&#39;career&#39;</span><span class="p">])</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
            <span class="k">if</span> <span class="n">selected_career</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">subjects</span> <span class="o">=</span> <span class="n">career_manager</span><span class="o">.</span><span class="n">query_subjects</span><span class="p">(</span><span class="n">selected_career</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">selected_subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
                    <span class="n">selection</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;teachers&#39;</span><span class="p">:</span>
                        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_teachers.html&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">get_docs_from_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;docs&#39;</span><span class="p">:</span>
                            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_docs.html&#39;</span>
                        <span class="k">elif</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;students&#39;</span><span class="p">:</span>
                            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_students.html&#39;</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La asignatura no ha sido encontrada.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">subjects</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subjects.html&#39;</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-teacher-subject&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_teacher_subject</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manages teacher assignments to subjects, allowing addition, removal, and consultation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template based on the selected action.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career_hidden&#39;</span><span class="p">)</span>
            <span class="n">option</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;new&#39;</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
                <span class="n">new_users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_role</span><span class="p">(</span><span class="s1">&#39;teacher&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">new_users</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
                <span class="n">result</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_add_subject_teachers.html&#39;</span>
            <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">get_teachers_for_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_remove_subject_teachers.html&#39;</span>
            <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;consult&#39;</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">get_teachers_for_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                <span class="n">role</span> <span class="o">=</span> <span class="s1">&#39;admin&#39;</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_consult_subject_teachers.html&#39;</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-consult-teacher-subject&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_consult_teacher_subject</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves and displays information about teacher assignments to subjects.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with teacher-subject assignment details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career_hidden&#39;</span><span class="p">)</span>
            <span class="n">role</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role_hidden&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;admin&#39;</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_teachers.html&#39;</span>
            <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;teacher&#39;</span><span class="p">:</span>
                <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">]:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_string_from_career_subject</span><span class="p">(</span><span class="n">subject</span><span class="p">))</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;teacher.html&#39;</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-add-teacher-subject&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_add_teacher_subject</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a teacher to a selected subject within a career.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with success or error messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_teacher</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select-teachers&#39;</span><span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_teachers.html&#39;</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">teachers</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">selected_teacher</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">teachers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">teacher</span> <span class="o">=</span> <span class="n">teachers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">has_user_subject</span><span class="p">(</span><span class="n">teacher</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El profesor ya estaba en la asignatura.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">user_manager</span><span class="o">.</span><span class="n">add_subject</span><span class="p">(</span><span class="n">teacher</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                        <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El profesor ha sido dado de alta en la asignatura.&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El profesor no existe en el sistema.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-remove-teacher-subject&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_remove_teacher_subject</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes a teacher from a selected subject within a career.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with success or error messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_teachers.html&#39;</span>
            <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_teacher</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select-teachers&#39;</span><span class="p">)</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">teachers</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">selected_teacher</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">teachers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">teacher</span> <span class="o">=</span> <span class="n">teachers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">user_manager</span><span class="o">.</span><span class="n">remove_subject</span><span class="p">(</span><span class="n">teacher</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El profesor ha sido eliminado de la asignatura satisfactoriamente.&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El profesor no existe en el sistema.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">delete_document</span><span class="p">(</span><span class="n">career</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes a document from a subject directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        career : str</span>
<span class="sd">            The career associated with the document.</span>
<span class="sd">        subject : str</span>
<span class="sd">            The subject where the document is stored.</span>
<span class="sd">        document : str</span>
<span class="sd">            The name of the document to delete.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        deleted : bool</span>
<span class="sd">            True if the document was successfully deleted, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">deleted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PROCESS_FOLDER&#39;</span><span class="p">]),</span> <span class="n">career</span><span class="p">),</span> <span class="n">subject</span><span class="p">),</span>
                                 <span class="n">document</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">deleted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">deleted</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/upload-docs&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">upload_docs</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uploads a document to a subject directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with success or error messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;upload-file&#39;</span><span class="p">]</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject_hidden&#39;</span><span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_docs.html&#39;</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No se ha seleccionado un documento nuevo para el temario.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pdf&#39;</span><span class="p">):</span>
                <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El documento no es un PDF adecuado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">career_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PROCESS_FOLDER&#39;</span><span class="p">],</span> <span class="n">selected_career</span><span class="p">)</span>
                <span class="n">destination_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">career_dir</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">destination_dir</span><span class="p">):</span>
                    <span class="n">doc_manager</span> <span class="o">=</span> <span class="n">DocManager</span><span class="p">()</span>
                    <span class="n">doc_manager</span><span class="o">.</span><span class="n">create_new_career_dir</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                <span class="n">destination_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">destination_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">destination_file</span><span class="p">):</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El documento ya está en el temario de la asignatura.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">destination_file</span><span class="p">)</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El documento ha sido guardado, en breve estará disponible&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">get_docs_from_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-docs-back&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_docs_back</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns to the document management view for a selected subject.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            The rendered template with the list of documents.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_docs.html&#39;</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject_hidden&#39;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">get_docs_from_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/admin-docs&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_docs</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles different administrative actions related to documents.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response</span>
<span class="sd">            The rendered template based on the selected action.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">option</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">)</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_doc</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select-docs&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;new&#39;</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_upload_docs.html&#39;</span>
            <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;download&#39;</span><span class="p">:</span>
                <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PROCESS_FOLDER&#39;</span><span class="p">],</span> <span class="n">selected_career</span><span class="p">),</span>
                                        <span class="n">selected_subject</span><span class="p">)</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">selected_doc</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_docs.html&#39;</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">get_docs_from_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El documento no ha podido ser descargado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;admin_subject_docs.html&#39;</span>
                <span class="k">if</span> <span class="n">delete_document</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">,</span> <span class="n">selected_doc</span><span class="p">):</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El documento ha sido eliminado.&#39;</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;El documento no ha podido eliminarse.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">get_docs_from_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles user logout by ending their session and cleaning up resources.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            Redirects the user to the home page after cleanup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">end_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;student&#39;</span><span class="p">:</span>
                <span class="n">clean_chatbots_by_student</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;home.html&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/chatbot-cleanup&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">chatbot_cleanup</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleans up chatbot instances associated with a student&#39;s session.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            JSON response indicating success.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">))</span>
        <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;student&#39;</span><span class="p">:</span>
                <span class="n">selected_career</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career&#39;</span><span class="p">))</span>
                <span class="n">selected_subject</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">))</span>
                <span class="n">clean_chatbot</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">},</span> <span class="mi">200</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/feedback&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">feedback</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Displays the feedback page for a student.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            Renders the feedback page.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career_hidden&#39;</span><span class="p">)</span>
            <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject_hidden&#39;</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pos_hidden&#39;</span><span class="p">)</span>
            <span class="n">conv_pos</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conv_pos_hidden&#39;</span><span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;feedback.html&#39;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/feedback-process&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">feedback_process</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes user feedback and updates the database.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            Redirects the user to the appropriate page based on their status.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pos_hidden&#39;</span><span class="p">))</span>
            <span class="n">conv_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conv_pos_hidden&#39;</span><span class="p">))</span>
            <span class="n">utility_feedback</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;utility-steps&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">learning_feedback</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;learning-steps&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">precision_feedback</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;precision-steps&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
                <span class="n">user_manager</span><span class="o">.</span><span class="n">update_feedback</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">conv_pos</span><span class="p">,</span> <span class="n">utility_feedback</span><span class="p">,</span> <span class="n">learning_feedback</span><span class="p">,</span>
                                             <span class="n">precision_feedback</span><span class="p">)</span>
            <span class="n">template</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">get_starting_page_user</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/chatbot&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">chatbot</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a chatbot session for the user.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            Redirects the user to the chatbot interface or an error page.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
            <span class="n">users</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">query_users_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select-subjects&#39;</span><span class="p">)</span>
                <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">get_career_subject_from_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;subjects&#39;</span><span class="p">]:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_string_from_career_subject</span><span class="p">(</span><span class="n">subject</span><span class="p">))</span>
                <span class="n">careers</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">career_manager</span> <span class="o">=</span> <span class="n">CareersManager</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">career</span> <span class="ow">in</span> <span class="n">career_manager</span><span class="o">.</span><span class="n">query_careers</span><span class="p">():</span>
                    <span class="n">careers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">career</span><span class="p">[</span><span class="s1">&#39;career&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">selected_career</span> <span class="ow">in</span> <span class="n">careers</span><span class="p">:</span>
                    <span class="n">subjects</span> <span class="o">=</span> <span class="n">career_manager</span><span class="o">.</span><span class="n">query_subjects</span><span class="p">(</span><span class="n">selected_career</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">selected_subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                            <span class="n">correct</span> <span class="o">=</span> <span class="n">chatbot_manager</span><span class="o">.</span><span class="n">add_chatbot</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">correct</span><span class="p">:</span>
                                <span class="n">user_manager</span><span class="o">.</span><span class="n">start_conversation</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                                <span class="n">pos</span><span class="p">,</span> <span class="n">conv_pos</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">user_manager</span><span class="o">.</span><span class="n">find_active_conversation_from_subject</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span>
                                                                                       <span class="n">selected_subject</span><span class="p">))</span>
                                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;chatbot.html&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La asignatura no tiene temario por lo que el tutor virtual &#39;</span>
                                      <span class="sa">f</span><span class="s1">&#39;no puede interactuar.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
                                <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;student.html&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La asignatura no ha sido encontrada.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
                        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;student.html&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La asignatura no ha sido encontrada.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;student.html&#39;</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/chat&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">chat</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Processes user input for the chatbot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            JSON response indicating success or error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;home.html&#39;</span>
        <span class="k">if</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_active</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">time_manager</span><span class="o">.</span><span class="n">reset_process</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prompt&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prompt</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
                        <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career&#39;</span><span class="p">)</span>
                        <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">)</span>
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">chatbot_manager</span><span class="o">.</span><span class="n">find_chatbot</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
                        <span class="n">current_chatbot</span> <span class="o">=</span> <span class="n">chatbot_manager</span><span class="o">.</span><span class="n">chatbots</span><span class="p">[</span><span class="n">email</span><span class="p">][</span><span class="n">pos</span><span class="p">]</span>
                        <span class="n">current_chatbot</span><span class="o">.</span><span class="n">prompt_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">},</span> <span class="mi">200</span>
        <span class="k">elif</span> <span class="n">time_manager</span><span class="o">.</span><span class="n">is_logged</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="n">flash</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;La sesión del usuario ha expirado.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">response</span>


    <span class="nd">@server</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/stream&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Streams chatbot responses to the user in real-time using SSE (Server-Sent Events).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response</span>
<span class="sd">            SSE event stream containing chatbot responses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">email</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">))</span>
            <span class="n">selected_career</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;career&#39;</span><span class="p">))</span>
            <span class="n">selected_subject</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">))</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">chatbot_manager</span><span class="o">.</span><span class="n">find_chatbot</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">event_stream</span><span class="p">(</span><span class="n">event_email</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
                    <span class="n">current_chatbot</span> <span class="o">=</span> <span class="n">chatbot_manager</span><span class="o">.</span><span class="n">chatbots</span><span class="p">[</span><span class="n">event_email</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">current_chatbot</span><span class="o">.</span><span class="n">send_sse_data</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">event_stream</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/event-stream&#39;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">render_dashboard</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Renders the dashboard page for a given user and subject.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Response : str</span>
<span class="sd">            Redirects the user to the dashboard page.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dash_app</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">create_layout</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;/dashapp/&#39;</span><span class="p">))</span>


    <span class="nd">@dash_app</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span>
        <span class="p">[</span><span class="n">Output</span><span class="p">(</span><span class="s1">&#39;mean-time-indicator&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;conversations-indicator&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;mean-conversations-indicator&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;mean-size-conversations-indicator&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;students-conversations-indicator&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;precision-feedback-indicator&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;utility-feedback-indicator&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;learning-feedback-indicator&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;mean-feedback-indicator&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;students-feedback-indicator&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;total-time-plot&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;conversations-plot&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;radar-plot&#39;</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;wordcloud&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;subject-dropdown&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;subject-dropdown&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;student-dropdown&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">),</span>
         <span class="n">Output</span><span class="p">(</span><span class="s1">&#39;student-dropdown&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">Input</span><span class="p">(</span><span class="s1">&#39;email_hidden&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
         <span class="n">Input</span><span class="p">(</span><span class="s1">&#39;subject-dropdown&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
         <span class="n">Input</span><span class="p">(</span><span class="s1">&#39;student-dropdown&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_graph</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">selected_subject_career</span><span class="p">,</span> <span class="n">selected_students</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates multiple visual indicators and plots in the dashboard based on selected subject and students.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        email : str</span>
<span class="sd">            The email address of the user requesting data.</span>
<span class="sd">        selected_subject_career : str</span>
<span class="sd">            The selected subject and career in the dropdown menu.</span>
<span class="sd">        selected_students : list</span>
<span class="sd">            The selected students for filtering data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            Updated Plotly figures and dropdown options for visualization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subject_options</span> <span class="o">=</span> <span class="n">get_subject_options</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="n">student_options</span> <span class="o">=</span> <span class="n">get_students_options</span><span class="p">()</span>
        <span class="n">subjects_value</span> <span class="o">=</span> <span class="n">subject_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">selected_students</span> <span class="o">=</span> <span class="n">get_student_selection</span><span class="p">(</span><span class="n">selected_students</span><span class="p">)</span>
        <span class="n">mean_time_indicator</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">conversations_indicator</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">mean_conversations_indicator</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">mean_size_conversations_indicator</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">student_conversations_indicator</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">precision_feedback_indicator</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">utility_feedback_indicator</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">learning_feedback_indicator</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">mean_feedback_indicator</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">students_feedback_indicator</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">total_time_plot</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">conversations_plot</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">radar_plot</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">cloud_plot</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">selected_subject_career</span> <span class="o">!=</span> <span class="s1">&#39;--&#39;</span><span class="p">:</span>
            <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">get_career_subject_from_string</span><span class="p">(</span><span class="n">selected_subject_career</span><span class="p">)</span>
            <span class="n">subjects_value</span> <span class="o">=</span> <span class="n">selected_subject_career</span>

            <span class="n">student_options</span> <span class="o">=</span> <span class="n">get_students_options</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/api/graph-data?selected_career=</span><span class="si">{</span><span class="n">selected_career</span><span class="si">}</span><span class="s1">&amp;selected_subject=&#39;</span>
                                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">selected_subject</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="p">(</span><span class="n">mean_time_indicator</span><span class="p">,</span> <span class="n">conversations_indicator</span><span class="p">,</span> <span class="n">mean_conversations_indicator</span><span class="p">,</span>
             <span class="n">mean_size_conversations_indicator</span><span class="p">,</span>
             <span class="n">student_conversations_indicator</span><span class="p">,</span> <span class="n">precision_feedback_indicator</span><span class="p">,</span> <span class="n">utility_feedback_indicator</span><span class="p">,</span>
             <span class="n">learning_feedback_indicator</span><span class="p">,</span> <span class="n">mean_feedback_indicator</span><span class="p">,</span> <span class="n">students_feedback_indicator</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">update_indicators</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">mean_time_indicator</span><span class="p">,</span> <span class="n">conversations_indicator</span><span class="p">,</span> <span class="n">mean_conversations_indicator</span><span class="p">,</span>
                                  <span class="n">mean_size_conversations_indicator</span><span class="p">,</span> <span class="n">student_conversations_indicator</span><span class="p">,</span>
                                  <span class="n">precision_feedback_indicator</span><span class="p">,</span> <span class="n">utility_feedback_indicator</span><span class="p">,</span> <span class="n">learning_feedback_indicator</span><span class="p">,</span>
                                  <span class="n">mean_feedback_indicator</span><span class="p">,</span> <span class="n">students_feedback_indicator</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_students</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/api/graph-data?selected_career=</span><span class="si">{</span><span class="n">selected_career</span><span class="si">}</span><span class="s1">&#39;</span>
                                                    <span class="sa">f</span><span class="s1">&#39;&amp;selected_subject=&#39;</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">selected_subject</span><span class="si">}</span><span class="s1">&amp;selected_students=&#39;</span>
                                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">selected_students</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">total_time_plot</span><span class="p">,</span> <span class="n">conversations_plot</span><span class="p">,</span> <span class="n">radar_plot</span><span class="p">,</span> <span class="n">cloud_plot</span> <span class="o">=</span> <span class="n">update_figures</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">total_time_plot</span><span class="p">,</span>
                                                                                         <span class="n">conversations_plot</span><span class="p">,</span> <span class="n">radar_plot</span><span class="p">,</span>
                                                                                         <span class="n">cloud_plot</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">mean_time_indicator</span><span class="p">,</span> <span class="n">conversations_indicator</span><span class="p">,</span> <span class="n">mean_conversations_indicator</span><span class="p">,</span>
                <span class="n">mean_size_conversations_indicator</span><span class="p">,</span> <span class="n">student_conversations_indicator</span><span class="p">,</span> <span class="n">precision_feedback_indicator</span><span class="p">,</span>
                <span class="n">utility_feedback_indicator</span><span class="p">,</span> <span class="n">learning_feedback_indicator</span><span class="p">,</span> <span class="n">mean_feedback_indicator</span><span class="p">,</span>
                <span class="n">students_feedback_indicator</span><span class="p">,</span> <span class="n">total_time_plot</span><span class="p">,</span> <span class="n">conversations_plot</span><span class="p">,</span> <span class="n">radar_plot</span><span class="p">,</span> <span class="n">cloud_plot</span><span class="p">,</span>
                <span class="n">subject_options</span><span class="p">,</span>
                <span class="n">subjects_value</span><span class="p">,</span> <span class="n">student_options</span><span class="p">,</span> <span class="n">selected_students</span><span class="p">)</span>


    <span class="c1"># Ruta de la API Flask para proporcionar los datos filtrados</span>
    <span class="nd">@server</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/graph-data&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">graph_data</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        API route to provide filtered graph data for visualizations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        None (Retrieves data from the request form).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        JSON</span>
<span class="sd">            Filtered student information relevant to the selected subject and career.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">selected_career</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;selected_career&#39;</span><span class="p">)</span>
        <span class="n">selected_subject</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;selected_subject&#39;</span><span class="p">)</span>
        <span class="n">user_manager</span> <span class="o">=</span> <span class="n">UserManager</span><span class="p">()</span>
        <span class="n">selected_students</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;selected_students&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">selected_students</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;selected_students&#39;</span><span class="p">))</span>
            <span class="n">selected_students</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_students</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">get_users_by_subject</span><span class="p">(</span><span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">student</span> <span class="ow">in</span> <span class="n">all_students</span><span class="p">:</span>
                <span class="n">selected_students</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">student</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
        <span class="n">info_students</span> <span class="o">=</span> <span class="n">get_info_from_students</span><span class="p">(</span><span class="n">selected_students</span><span class="p">,</span> <span class="n">selected_career</span><span class="p">,</span> <span class="n">selected_subject</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">info_students</span><span class="p">)</span>


    <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;TOKENIZERS_PARALLELISM&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
    <span class="n">time_manager</span><span class="o">.</span><span class="n">create_dict</span><span class="p">()</span>
    <span class="n">server_port</span> <span class="o">=</span> <span class="mi">8080</span>
    <span class="n">server_numthreads</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">server_timeout</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">server_request_queue_size</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="c1">#wsgi_server = WSGIServer((&#39;0.0.0.0&#39;, server_port), PathInfoDispatcher({&#39;/&#39;: server}),</span>
    <span class="c1">#                         numthreads=server_numthreads, timeout=server_timeout,</span>
    <span class="c1">#                         request_queue_size=server_request_queue_size)</span>

    <span class="c1">#ssl_cert = &quot;/home/alberto/PycharmProjects/ViLT/dolguldur_etsii_urjc_es_cert.cer&quot;</span>
    <span class="c1">#ssl_key = &quot;/home/alberto/PycharmProjects/ViLT/dolguldur_etsii_urjc_es.key&quot;</span>
    <span class="c1">#wsgi_server.ssl_adapter = BuiltinSSLAdapter(ssl_cert, ssl_key, None)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#wsgi_server.start()</span>
        <span class="n">server</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">server_port</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ConnectionResetError</span> <span class="k">as</span> <span class="n">connection_error</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Connection reset error </span><span class="si">{</span><span class="n">connection_error</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;User interrupted.&#39;</span><span class="p">)</span>
        <span class="c1">#wsgi_server.stop()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Alberto Fernández Isabel.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>